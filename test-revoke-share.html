<!DOCTYPE html>
<html>
<head>
  <title>Test Revoke Share Feature</title>
</head>
<body>
  <h1>Test Revoke Share Feature</h1>
  <div id="output"></div>

  <script>
    const API_BASE = 'http://localhost:3000/api';
    const output = document.getElementById('output');

    async function testRevokeShare() {
      try {
        // Step 1: Get conversations
        output.innerHTML += '<p>Step 1: Fetching conversations...</p>';
        const convsResponse = await fetch(`${API_BASE}/conversations`);
        const conversations = await convsResponse.json();
        output.innerHTML += `<p>Found ${conversations.length} conversations</p>`;

        if (conversations.length === 0) {
          output.innerHTML += '<p>Error: No conversations found</p>';
          return;
        }

        const conversationId = conversations[0].id;
        output.innerHTML += `<p>Using conversation ID: ${conversationId}</p>`;

        // Step 2: Create a share link
        output.innerHTML += '<p>Step 2: Creating share link...</p>';
        const shareResponse = await fetch(`${API_BASE}/conversations/${conversationId}/share`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        const shareData = await shareResponse.json();
        output.innerHTML += `<p>Share token created: ${shareData.share_token}</p>`;
        const shareToken = shareData.share_token;
        const shareUrl = `http://localhost:5173/share/${shareToken}`;
        output.innerHTML += `<p>Share URL: ${shareUrl}</p>`;

        // Step 3: Verify share link works
        output.innerHTML += '<p>Step 3: Verifying share link works...</p>';
        const verifyResponse = await fetch(`${API_BASE}/share/${shareToken}`);
        if (verifyResponse.ok) {
          const shareContent = await verifyResponse.json();
          output.innerHTML += `<p>✓ Share link works! Conversation title: ${shareContent.conversation?.title || 'N/A'}</p>`;
        } else {
          output.innerHTML += `<p>✗ Share link failed: ${verifyResponse.status}</p>`;
          return;
        }

        // Step 4: Revoke the share link
        output.innerHTML += '<p>Step 4: Revoking share link...</p>';
        const revokeResponse = await fetch(`${API_BASE}/share/${shareToken}`, {
          method: 'DELETE'
        });
        if (revokeResponse.ok) {
          output.innerHTML += '<p>✓ Share link revoked successfully</p>';
        } else {
          output.innerHTML += `<p>✗ Revoke failed: ${revokeResponse.status}</p>`;
          return;
        }

        // Step 5: Verify share link no longer works
        output.innerHTML += '<p>Step 5: Verifying share link is revoked...</p>';
        const verifyRevokedResponse = await fetch(`${API_BASE}/share/${shareToken}`);
        if (verifyRevokedResponse.status === 404) {
          output.innerHTML += '<p>✓ Share link correctly returns 404 (revoked)</p>';
          output.innerHTML += '<h2 style="color: green;">ALL TESTS PASSED!</h2>';
        } else {
          output.innerHTML += `<p>✗ Expected 404, got: ${verifyRevokedResponse.status}</p>`;
        }

      } catch (error) {
        output.innerHTML += `<p style="color: red;">Error: ${error.message}</p>`;
      }
    }

    // Run test on page load
    testRevokeShare();
  </script>
</body>
</html>
