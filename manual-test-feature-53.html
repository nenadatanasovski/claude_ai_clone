<!DOCTYPE html>
<html>
<head>
  <title>Manual Test - Feature 53</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    .step { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
    .success { background: #d4edda; border-color: #c3e6cb; }
    .error { background: #f8d7da; border-color: #f5c6cb; }
    button { padding: 10px 20px; margin: 5px; cursor: pointer; }
    code { background: #f4f4f4; padding: 2px 6px; border-radius: 3px; }
    .link { color: blue; word-break: break-all; }
  </style>
</head>
<body>
  <h1>Manual Test - Feature #53: Revoke Shared Conversation Link</h1>

  <div class="step">
    <h3>Step 1: Create a Share Link</h3>
    <button onclick="createShare()">Create Share Link</button>
    <div id="step1-result"></div>
  </div>

  <div class="step">
    <h3>Step 2: Verify Share Link Works</h3>
    <button onclick="verifyShare()" id="verify-btn" disabled>Verify Share Link</button>
    <div id="step2-result"></div>
  </div>

  <div class="step">
    <h3>Step 3: Test UI - Open Share Modal</h3>
    <p>Now go to the main app and:</p>
    <ol>
      <li>Right-click on a conversation in the sidebar</li>
      <li>Click "Share" from the context menu</li>
      <li>You should see the share modal with "Active Share Links" section</li>
      <li>Click the red "Revoke" button</li>
      <li>Confirm the revocation in the confirmation dialog</li>
    </ol>
    <button onclick="window.open('http://localhost:5173', '_blank')">Open Main App</button>
  </div>

  <div class="step">
    <h3>Step 4: Verify Share Link is Revoked</h3>
    <p>After revoking in the UI, come back here and verify:</p>
    <button onclick="verifyRevoked()" id="revoke-verify-btn" disabled>Verify Link is Revoked</button>
    <div id="step4-result"></div>
  </div>

  <script>
    const API_BASE = 'http://localhost:3001/api';
    let shareToken = null;
    let shareUrl = null;
    let conversationId = null;

    async function createShare() {
      const result = document.getElementById('step1-result');
      result.innerHTML = 'Creating share link...';

      try {
        // Get first conversation
        const convsResp = await fetch(`${API_BASE}/conversations`);
        const convs = await convsResp.json();

        if (convs.length === 0) {
          result.innerHTML = '<p class="error">No conversations found!</p>';
          return;
        }

        conversationId = convs[0].id;

        // Create share
        const shareResp = await fetch(`${API_BASE}/conversations/${conversationId}/share`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await shareResp.json();
        shareToken = data.share_token;
        shareUrl = `http://localhost:5173/share/${shareToken}`;

        result.innerHTML = `
          <p class="success">✓ Share link created successfully!</p>
          <p><strong>Token:</strong> <code>${shareToken}</code></p>
          <p><strong>URL:</strong> <a href="${shareUrl}" target="_blank" class="link">${shareUrl}</a></p>
          <p><strong>Conversation ID:</strong> ${conversationId}</p>
        `;

        document.getElementById('verify-btn').disabled = false;
        document.getElementById('revoke-verify-btn').disabled = false;

      } catch (error) {
        result.innerHTML = `<p class="error">Error: ${error.message}</p>`;
      }
    }

    async function verifyShare() {
      const result = document.getElementById('step2-result');
      result.innerHTML = 'Verifying share link...';

      try {
        const resp = await fetch(`${API_BASE}/share/${shareToken}`);

        if (resp.ok) {
          const data = await shareResp.json();
          result.innerHTML = `
            <p class="success">✓ Share link works! Status: ${resp.status}</p>
            <p>Try opening it: <a href="${shareUrl}" target="_blank">${shareUrl}</a></p>
          `;
        } else {
          result.innerHTML = `<p class="error">✗ Share link failed! Status: ${resp.status}</p>`;
        }

      } catch (error) {
        result.innerHTML = `<p class="error">Error: ${error.message}</p>`;
      }
    }

    async function verifyRevoked() {
      const result = document.getElementById('step4-result');
      result.innerHTML = 'Verifying share link is revoked...';

      try {
        const resp = await fetch(`${API_BASE}/share/${shareToken}`);

        if (resp.status === 404) {
          result.innerHTML = `
            <p class="success">✓ PERFECT! Share link returns 404 (revoked successfully)</p>
            <p><strong>Feature #53 is working correctly!</strong></p>
          `;
        } else {
          result.innerHTML = `
            <p class="error">✗ Expected 404, but got ${resp.status}</p>
            <p>The share link may not have been properly revoked.</p>
          `;
        }

      } catch (error) {
        result.innerHTML = `<p class="error">Error: ${error.message}</p>`;
      }
    }
  </script>
</body>
</html>
