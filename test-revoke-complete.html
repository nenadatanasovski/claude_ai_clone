<!DOCTYPE html>
<html>
<head>
  <title>Complete Revoke Test</title>
  <style>
    body { font-family: sans-serif; margin: 20px; max-width: 800px; }
    .step { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
    .success { background: #d4edda; }
    .error { background: #f8d7da; }
    .pending { background: #fff3cd; }
    code { background: #f4f4f4; padding: 2px 6px; }
  </style>
</head>
<body>
  <h1>Feature #53: Complete Revoke Test</h1>
  <button onclick="runCompleteTest()">Run Complete Test</button>
  <div id="results"></div>

  <script>
    const API_BASE = 'http://localhost:3001/api';
    const TOKEN = '714b0588cabd1cfa009ca67da75db21c'; // From our previous test

    async function runCompleteTest() {
      const results = document.getElementById('results');
      results.innerHTML = '';

      // Step 1: Verify share exists and works
      results.innerHTML += '<div class="step pending"><h3>Step 1: Verifying share link exists...</h3></div>';
      try {
        const resp = await fetch(`${API_BASE}/share/${TOKEN}`);
        if (resp.ok) {
          results.innerHTML += '<div class="step success"><h3>Step 1: âœ“ Share link exists and works</h3><p>Status: ' + resp.status + '</p></div>';
        } else {
          results.innerHTML += '<div class="step error"><h3>Step 1: âœ— Share link not found</h3><p>Status: ' + resp.status + '</p><p>Cannot proceed with revoke test.</p></div>';
          return;
        }
      } catch (e) {
        results.innerHTML += '<div class="step error"><h3>Step 1: âœ— Error</h3><p>' + e.message + '</p></div>';
        return;
      }

      // Step 2: Revoke the share link
      results.innerHTML += '<div class="step pending"><h3>Step 2: Revoking share link...</h3></div>';
      try {
        const resp = await fetch(`${API_BASE}/share/${TOKEN}`, {
          method: 'DELETE'
        });
        if (resp.ok) {
          const data = await resp.json();
          results.innerHTML += '<div class="step success"><h3>Step 2: âœ“ Share link revoked</h3><p>Response: ' + JSON.stringify(data) + '</p></div>';
        } else {
          results.innerHTML += '<div class="step error"><h3>Step 2: âœ— Revoke failed</h3><p>Status: ' + resp.status + '</p></div>';
          return;
        }
      } catch (e) {
        results.innerHTML += '<div class="step error"><h3>Step 2: âœ— Error</h3><p>' + e.message + '</p></div>';
        return;
      }

      // Step 3: Verify share link no longer works
      results.innerHTML += '<div class="step pending"><h3>Step 3: Verifying share link is revoked...</h3></div>';
      try {
        const resp = await fetch(`${API_BASE}/share/${TOKEN}`);
        if (resp.status === 404) {
          results.innerHTML += '<div class="step success"><h3>Step 3: âœ“ Share link correctly returns 404</h3><p>Access properly denied!</p></div>';
          results.innerHTML += '<div class="step success"><h2>ðŸŽ‰ ALL TESTS PASSED! Feature #53 works correctly!</h2></div>';
        } else {
          results.innerHTML += '<div class="step error"><h3>Step 3: âœ— Expected 404, got ' + resp.status + '</h3></div>';
        }
      } catch (e) {
        results.innerHTML += '<div class="step error"><h3>Step 3: âœ— Error</h3><p>' + e.message + '</p></div>';
      }
    }
  </script>
</body>
</html>
